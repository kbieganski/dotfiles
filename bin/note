#!/bin/env bash

print=false
if [ -n "$NVIM" ]; then
    print=true
fi
grep=false
if [ "$1" == "--grep" ]; then
    grep=true
    shift
elif [ $# -gt 0 ]; then
    echo "Invalid arguments"
    exit 1
fi

notes_dir="$HOME/notes"
mkdir -p "$notes_dir"
cd "$notes_dir" &>/dev/null

action="accept"

if $grep; then
    if ! $print; then
        action="become(nvim +{2} {1})"
    fi

    reload='reload:rg --line-number --color=always --smart-case {q} || :'
    fzf --disabled --ansi --multi \
        --bind "start:$reload" --bind "change:$reload" \
        --bind "enter:$action" \
        --delimiter : \
        --preview 'bat {1} --color=always --highlight-line {2}' \
        --preview-window '<80(up)' \
        --query "$*"
else
    if ! $print; then
        action="become(nvim {})"
    fi

    fzf --bind "start:reload:fd '.*\\.md' --base-directory '$notes_dir' | sed 's/.md$//'" \
        --bind "enter:$action" \
        --bind "alt-enter:print-query+abort" \
        --preview "bat $(echo {}).md --color=always"
fi
